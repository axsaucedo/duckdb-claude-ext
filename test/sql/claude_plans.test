# name: test/sql/claude_plans.test
# description: comprehensive tests for Claude plan loading
# group: [agent_data]

require agent_data

# ============================================================
# Row counts
# ============================================================

query I
SELECT COUNT(*) FROM read_plans(path='test/data');
----
4

# All rows have source = 'claude'
query I
SELECT COUNT(*) FROM read_plans(path='test/data') WHERE source != 'claude';
----
0

# ============================================================
# Column NOT NULL invariants
# ============================================================

# plan_name never empty
query I
SELECT COUNT(*) FROM read_plans(path='test/data') WHERE plan_name = '' OR plan_name IS NULL;
----
0

# file_name never empty
query I
SELECT COUNT(*) FROM read_plans(path='test/data') WHERE file_name = '' OR file_name IS NULL;
----
0

# file_path never empty
query I
SELECT COUNT(*) FROM read_plans(path='test/data') WHERE file_path = '' OR file_path IS NULL;
----
0

# content never empty
query I
SELECT COUNT(*) FROM read_plans(path='test/data') WHERE content = '' OR content IS NULL;
----
0

# file_size always positive
query I
SELECT COUNT(*) FROM read_plans(path='test/data') WHERE file_size <= 0;
----
0

# ============================================================
# Plan names are distinct
# ============================================================

query I
SELECT COUNT(*) - COUNT(DISTINCT plan_name) FROM read_plans(path='test/data');
----
0

# ============================================================
# Claude plans have NULL session_id (global plans)
# ============================================================

query I
SELECT COUNT(*) FROM read_plans(path='test/data') WHERE session_id IS NOT NULL;
----
0

# ============================================================
# File size matches content length
# ============================================================

query I
SELECT COUNT(*) FROM read_plans(path='test/data') WHERE file_size != LENGTH(content);
----
0

# ============================================================
# Plan names are the expected values (sorted)
# ============================================================

query I
SELECT COUNT(*) FROM read_plans(path='test/data')
WHERE plan_name IN ('binary-juggling-wolf', 'bright-napping-stream', 'bright-napping-wolf', 'swift-exploring-stream');
----
4
