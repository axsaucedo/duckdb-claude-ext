# name: test/sql/claude_stats.test
# description: comprehensive tests for Claude stats loading
# group: [agent_data]

require agent_data

# ============================================================
# Row counts
# ============================================================

query I
SELECT COUNT(*) FROM read_stats(path='test/data');
----
7

# All rows have source = 'claude'
query I
SELECT COUNT(*) FROM read_stats(path='test/data') WHERE source != 'claude';
----
0

# ============================================================
# Column NOT NULL invariants
# ============================================================

# Date never empty
query I
SELECT COUNT(*) FROM read_stats(path='test/data') WHERE date = '' OR date IS NULL;
----
0

# Counts non-negative
query I
SELECT COUNT(*) FROM read_stats(path='test/data')
WHERE message_count < 0 OR session_count < 0 OR tool_call_count < 0;
----
0

# ============================================================
# Dates are unique (one row per day)
# ============================================================

query I
SELECT COUNT(*) - COUNT(DISTINCT date) FROM read_stats(path='test/data');
----
0

# ============================================================
# Date format validation
# ============================================================

query I
SELECT COUNT(*) FROM read_stats(path='test/data')
WHERE date NOT SIMILAR TO '[0-9]{4}-[0-9]{2}-[0-9]{2}';
----
0

# ============================================================
# Aggregate totals (pinned)
# ============================================================

query I
SELECT CAST(SUM(message_count) AS BIGINT) FROM read_stats(path='test/data');
----
2096

query I
SELECT CAST(SUM(session_count) AS BIGINT) FROM read_stats(path='test/data');
----
22

query I
SELECT CAST(SUM(tool_call_count) AS BIGINT) FROM read_stats(path='test/data');
----
779

# ============================================================
# Activity is positive (at least some messages/sessions)
# ============================================================

query I
SELECT SUM(message_count) > 0 FROM read_stats(path='test/data');
----
true

query I
SELECT SUM(session_count) > 0 FROM read_stats(path='test/data');
----
true
